-- First, let's verify the primary key columns (run this separately if needed)
/*
SELECT COLUMN_NAME 
FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
WHERE OBJECTPROPERTY(OBJECT_ID(CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME), 'IsPrimaryKey') = 1
AND TABLE_NAME = '#TRANSACTION_TMP'
ORDER BY ORDINAL_POSITION;
*/

-- Now the main INSERT with proper duplicate checking
INSERT INTO #TRANSACTION_TMP (
    [TRA_CodEtat], [TRA_TypSrc], [TRA_IdSrc], TRA_Workflow, [TRA_CodSociete],
    [TRA_CodIdentifiantClient], [TRA_IdTiersDecisionnaire], [TRA_CanalOrdreClient],
    [TRA_CodPrestataireOrigine], [TRA_CodPrestataire], [TRA_MarcheOTC],
    [TRA_TypTiersContrepartie], [TRA_IdTiersContrepartie], [TRA_CodTypDistribution],
    [TRA_IdOrdreMarche], [TRA_IdExecution], [TRA_IdExterneTransactionMarche],
    [TRA_IdCollaborateurExec], [TRA_IdAlgorithme], [TRA_TradingDateTime],
    [TRA_IdInstrument], [TRA_CodSens], [TRA_IsVenteADecouvert], [TRA_Qte],
    [TRA_DeviseQte], [TRA_Prix], [TRA_DevisePrix], [TRA_MontantNet],
    TRA_TransmitterCodLEI, TRA_Counterparty_Id, TRA_ExecId, TRA_TradeId,
    TRA_OrderId, TRA_BrokerId, TRA_lastMarket
)
SELECT DISTINCT
    'CONSO',
    'ULL',
    table_id,
    'b_i/market/' + ISNULL(ownerdesk_op,'') + '/' + ISNULL(ordercapacity,''),
    COALESCE(vrt.codsociete, evd.CODE_SOCIETE, 'ODO'),
    COALESCE(DataTransmittedClientLEI, clientId_op, NULLIF(bookid,'Washbook_Client')),
    NULL,
    CASE WHEN traderId = 'WebOddo' THEN 'WEB' WHEN ORN IS NOT NULL THEN 'FIX' WHEN ORN IS NULL AND clientid IS NULL THEN 'VOIX' END,
    LEFT(CASE WHEN LEFT(clientId_op,7) = 'ROUTAGE' THEN 'CARNET INSTRUCTION' ELSE ORN END,20),
    'ULLINK',
    [Marché/OTC],
    CASE WHEN ISNULL(BrokerId,'') IN ('ULBB_PLAT','ODDO','') OR ExDestination IN ('XMON','XEUR') THEN 'VENUE' ELSE 'BROKER' END,
    CASE WHEN ISNULL(BrokerId,'') IN ('ULBB_PLAT') OR ISNULL(BrokerId,'') IN ('ODDO','') THEN lastMarket
         WHEN ExDestination IN ('XMON','XEUR') THEN ExDestination
         ELSE BrokerId END,
    CASE WHEN COALESCE(vrt.codsociete,'',evd.CODE_SOCIETE) = 'OCF' AND ISNULL(ordercapacity,'') IN ('','liquidityprovider','principal') THEN 'GSM'
         WHEN ISNULL([ID Utilisateur ordre marché],'') = 'OMSReport' AND LEFT(ISNULL(clientId_op,''),7) != 'ODDOCAC' THEN 'RTO'
         ELSE LEFT(ordercapacity,20) END,
    RefOrder,
    Ul_id,
    ARM_TVTIC,
    CASE WHEN [owner] = 'execution_channel' THEN orderowner WHEN [owner] LIKE 'OMSReport%' THEN traderid ELSE owner END,
    CASE WHEN LEFT(clientId_op,7) = 'ODDOCAC' AND CONVERT(VARCHAR, clientSource) = 'I_MARVELSOFT' THEN CONVERT(VARCHAR, instructions_trading) END,
    [Timestamp négociation],
    Altid_Isin,
    Sens,
    NULL,
    [Quantité exécutée],
    CASE WHEN GIN_CodTypeExpressionCours IN ('02','03','') THEN [Monnaie prix] END,
    CASE WHEN [Monnaie prix] = 'GBX' THEN Prix/100 ELSE Prix END,
    CASE WHEN [Monnaie prix] = 'GBX' THEN 'GBP' ELSE LEFT([Monnaie prix],3) END,
    NULL,
    CASE WHEN DataTransmittedClientLEI IS NOT NULL THEN '969500IHDSNRRY5LDB67' END,
    Counterparty_Id,
    EXECID,
    UL_ID,
    REFORDER,
    BrokerId,
    lastMarket
FROM RD2_V_TRA_ULLINK WITH(NOLOCK)
OUTER APPLY (SELECT * FROM RD2_V_REF_TIERS WHERE clientId_op = code AND code IS NOT NULL) vrt
LEFT JOIN #EVD_EVOLUTION_DEPOUILLEMENT AS evd ON Ul_id = evd.REF_UL_ID COLLATE SQL_Latin1_General_CP1_CS_AS AND evd.dr = 1
LEFT JOIN (
    SELECT * FROM (
        SELECT GIN_CodISIN, GIN_CodNature, GIN_CodTypeExpressionCours,
        ROW_NUMBER() OVER(PARTITION BY GIN_CodISIN ORDER BY GIN_CodISIN DESC) AS RowNumberRank 
        FROM INS_GIN_GeneriqueInstruments
        WHERE GIN_CodNature IS NOT NULL AND GIN_CodISIN IS NOT NULL
    ) AS b 
    WHERE b.RowNumberRank = 1
) AS GIN ON gin.GIN_CodISIN = Altid_Isin
WHERE NOT EXISTS (
    SELECT 1 
    FROM #TRANSACTION_TMP dest
    WHERE dest.[TRA_TypSrc] = 'ULL'  -- First PK column
      AND dest.[TRA_IdSrc] = RD2_V_TRA_ULLINK.table_id  -- Second PK column
      AND dest.[TRA_TradeId] = RD2_V_TRA_ULLINK.UL_ID  -- Third PK column
);
