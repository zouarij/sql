WITH SourceData AS (
    SELECT
        ROW_NUMBER() OVER (
            PARTITION BY 
                COALESCE(vrt.codsociete, evd.CODE_SOCIETE, 'ODO'),
                'ULL',
                table_id
            ORDER BY [Timestamp n√©gociation] DESC
        ) AS rn,
        'CONSO' AS TRA_CodEtat, 
        'ULL' AS TRA_TypSrc, 
        table_id AS TRA_IdSrc,
        'b_i/market/' + ISNULL(ownerdesk_op,'') + '/' + ISNULL(ordercapacity,'') AS TRA_Workflow,
        COALESCE(vrt.codsociete, evd.CODE_SOCIETE, 'ODO') AS TRA_CodSociete,
        COALESCE(DataTransmittedClientLEI, clientId_op, NULLIF(bookid,'Washbook_Client')) AS TRA_CodIdentifiantClient,
        -- rest of your columns ...
        Counterparty_Id, EXECID, UL_ID, REFORDER, BrokerId, lastMarket
    FROM RD2_V_TRA_ULLINK WITH (NOLOCK)
    OUTER APPLY (SELECT * FROM RD2_V_REF_TIERS WHERE clientId_op = code AND code IS NOT NULL) vrt
    LEFT JOIN #EVD_EVOLUTION_DEPOUILLEMENT evd ON Ul_id = evd.REF_UL_ID COLLATE SQL_Latin1_General_CP1_CS_AS AND evd.dr = 1
    LEFT JOIN (
        SELECT * FROM (
            SELECT GIN_CodISIN, GIN_CodNature, GIN_CodTypeExpressionCours,
                   ROW_NUMBER() OVER(PARTITION BY GIN_CodISIN ORDER BY GIN_CodISIN DESC) AS RowNumberRank
            FROM INS_GIN_GeneriqueInstruments
            WHERE GIN_CodNature IS NOT NULL AND GIN_CodISIN IS NOT NULL
        ) b WHERE b.RowNumberRank=1
    ) GIN ON GIN.GIN_CodISIN = Altid_Isin
    WHERE table_id = '10043182544'
)

MERGE INTO #TRANSACTION_TMP AS target
USING (
    SELECT * FROM SourceData WHERE rn = 1 -- Keep only first row per PK
) AS src
ON target.TRA_CodSociete = src.TRA_CodSociete
   AND target.TRA_TypSrc = src.TRA_TypSrc
   AND target.TRA_IdSrc = src.TRA_IdSrc

WHEN NOT MATCHED THEN
    INSERT (
        TRA_CodEtat, TRA_TypSrc, TRA_IdSrc, TRA_Workflow, TRA_CodSociete,
        TRA_CodIdentifiantClient, -- rest of your columns ...
        Counterparty_Id, EXECID, UL_ID, REFORDER, BrokerId, lastMarket
    )
    VALUES (
        src.TRA_CodEtat, src.TRA_TypSrc, src.TRA_IdSrc, src.TRA_Workflow, src.TRA_CodSociete,
        src.TRA_CodIdentifiantClient, -- rest of your columns ...
        src.Counterparty_Id, src.EXECID, src.UL_ID, src.REFORDER, src.BrokerId, src.lastMarket
    );
